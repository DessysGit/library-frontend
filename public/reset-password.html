<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Des2 Library</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Header Section -->
    <header class="header text-center">
        <div class="container">
            <h1 class="stylish-logo">Des2 Library</h1>
            <p class="slogan">Reset Your Password</p>
        </div>
    </header>

    <div class="container mt-5">
        <!-- Loading State -->
        <div id="loading-state" class="text-center">
            <div class="card">
                <div class="card-body">
                    <div class="spinner-border text-success" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="mt-3 text-white">Validating reset link...</p>
                </div>
            </div>
        </div>

        <!-- Invalid Token Message -->
        <div id="invalid-token" class="mt-4" style="display: none;">
            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-exclamation-triangle text-danger" style="font-size: 48px;"></i>
                    <h2 class="card-title text-danger mt-3">Invalid or Expired Link</h2>
                    <p class="mt-3">This password reset link is invalid, expired, or has already been used.</p>
                    <p>Password reset links expire after 1 hour for security reasons.</p>
                    <div class="mt-4">
                        <a href="index.html" class="btn btn-primary mr-2">Return to Login</a>
                        <a href="index.html" onclick="showForgotPasswordOnLoad()" class="btn btn-secondary">Request New Reset Link</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reset Password Form -->
        <div id="reset-form" class="mt-4" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title text-center">
                        <i class="fas fa-key text-success"></i> Create New Password
                    </h2>
                    <p class="text-center text-muted mb-4">Enter your new password below</p>
                    
                    <div class="form-group">
                        <label for="new-password">New Password *</label>
                        <input type="password" id="new-password" class="form-control" placeholder="At least 6 characters" required>
                        <div class="password-strength">
                            <div class="password-strength-bar"></div>
                        </div>
                        <small class="text-muted">Use a mix of letters, numbers, and symbols for better security</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm-password">Confirm New Password *</label>
                        <input type="password" id="confirm-password" class="form-control" placeholder="Repeat your password" required>
                    </div>
                    
                    <button type="button" onclick="resetPassword()" class="btn btn-success btn-block mb-3" id="reset-btn">
                        Reset Password
                    </button>
                    <div id="reset-messages" class="mt-2"></div>
                    
                    <div class="text-center mt-3">
                        <a href="index.html" class="text-muted">Cancel and return to login</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Message -->
        <div id="success-message" class="mt-4" style="display: none;">
            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle text-success" style="font-size: 48px;"></i>
                    <h2 class="card-title text-success mt-3">Password Reset Successful!</h2>
                    <p class="mt-3">Your password has been changed successfully.</p>
                    <p>You can now log in with your new password.</p>
                    <div class="mt-4">
                        <a href="index.html" class="btn btn-success btn-lg">Go to Login</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    
    <script>
        // Automatic API URL detection
        const API_BASE_URL = (() => {
            const currentHost = window.location.hostname;
            const isLocalhost = currentHost === 'localhost' || currentHost === '127.0.0.1';
            
            if (isLocalhost) {
                return 'http://localhost:3000';
            } else {
                return 'https://library-backend-j90e.onrender.com';
            }
        })();

        let resetToken = null;

        // Get token from URL and validate
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            resetToken = urlParams.get('token');

            if (!resetToken) {
                showInvalidToken();
                return;
            }

            await validateToken(resetToken);
            initializePasswordStrength();
        });

        // Validate reset token
        async function validateToken(token) {
            try {
                const response = await fetch(`${API_BASE_URL}/validate-reset-token/${token}`);
                const data = await response.json();

                document.getElementById('loading-state').style.display = 'none';

                if (data.valid) {
                    document.getElementById('reset-form').style.display = 'block';
                } else {
                    showInvalidToken();
                }
            } catch (error) {
                console.error('Error validating token:', error);
                document.getElementById('loading-state').style.display = 'none';
                showInvalidToken();
            }
        }

        // Show invalid token message
        function showInvalidToken() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('reset-form').style.display = 'none';
            document.getElementById('invalid-token').style.display = 'block';
        }

        // Reset password
        async function resetPassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const resetButton = document.getElementById('reset-btn');

            // Clear messages
            document.getElementById('reset-messages').innerHTML = '';

            // Validation
            const errors = [];

            if (!newPassword) {
                errors.push('Password is required');
            } else if (newPassword.length < 6) {
                errors.push('Password must be at least 6 characters long');
            }

            if (!confirmPassword) {
                errors.push('Please confirm your password');
            } else if (newPassword !== confirmPassword) {
                errors.push('Passwords do not match');
            }

            if (errors.length > 0) {
                displayMessage('reset-messages', errors.join('<br>'), 'error');
                return;
            }

            // Show spinner
            showButtonSpinner(resetButton, 'Reset Password');

            try {
                const response = await fetch(`${API_BASE_URL}/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        token: resetToken, 
                        newPassword: newPassword 
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Show success message
                    document.getElementById('reset-form').style.display = 'none';
                    document.getElementById('success-message').style.display = 'block';
                } else {
                    displayMessage('reset-messages', data.message || data.error || 'Failed to reset password', 'error');
                }
            } catch (error) {
                console.error('Password reset error:', error);
                displayMessage('reset-messages', 'Network error. Please try again.', 'error');
            } finally {
                hideButtonSpinner(resetButton);
            }
        }

        // Password strength indicator
        function initializePasswordStrength() {
            const passwordInput = document.getElementById('new-password');
            const strengthContainer = passwordInput?.parentElement.querySelector('.password-strength');
            const strengthBar = strengthContainer?.querySelector('.password-strength-bar');

            if (!passwordInput || !strengthContainer || !strengthBar) return;

            passwordInput.addEventListener('input', function() {
                const password = this.value;
                const strength = calculatePasswordStrength(password);
                updatePasswordStrengthUI(strengthContainer, strengthBar, strength);
            });
        }

        function calculatePasswordStrength(password) {
            if (!password) return { level: 'none', score: 0 };

            let score = 0;

            if (password.length >= 6) score += 1;
            if (password.length >= 8) score += 1;
            if (password.length >= 12) score += 1;
            if (/[a-z]/.test(password)) score += 1;
            if (/[A-Z]/.test(password)) score += 1;
            if (/[0-9]/.test(password)) score += 1;
            if (/[^a-zA-Z0-9]/.test(password)) score += 1;

            let level = 'weak';
            if (score >= 5) level = 'strong';
            else if (score >= 3) level = 'medium';

            return { level, score };
        }

        function updatePasswordStrengthUI(container, bar, strength) {
            container.classList.remove('password-strength-weak', 'password-strength-medium', 'password-strength-strong');
            
            if (strength.level !== 'none') {
                container.classList.add(`password-strength-${strength.level}`);
            }

            const widthPercentage = Math.min((strength.score / 7) * 100, 100);
            bar.style.width = `${widthPercentage}%`;
            
            if (strength.level === 'weak') {
                bar.style.backgroundColor = '#dc3545';
            } else if (strength.level === 'medium') {
                bar.style.backgroundColor = '#ffc107';
            } else if (strength.level === 'strong') {
                bar.style.backgroundColor = '#28a745';
            }
        }

        // Display message helper
        function displayMessage(elementId, message, type = 'error') {
            const messageElement = document.getElementById(elementId);
            if (messageElement) {
                let alertClass = 'alert-danger';
                if (type === 'success') alertClass = 'alert-success';
                if (type === 'info') alertClass = 'alert-info';
                
                messageElement.innerHTML = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>`;
            }
        }

        // Button spinner helpers
        function showButtonSpinner(buttonElement, originalText) {
            buttonElement.disabled = true;
            buttonElement.classList.add('loading');
            buttonElement.setAttribute('data-original-text', originalText);
            buttonElement.innerHTML = `
                <span class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span>
                Processing...
            `;
        }

        function hideButtonSpinner(buttonElement) {
            buttonElement.disabled = false;
            buttonElement.classList.remove('loading');
            const originalText = buttonElement.getAttribute('data-original-text') || 'Submit';
            buttonElement.innerHTML = originalText;
            buttonElement.removeAttribute('data-original-text');
        }

        // Enter key support
        document.addEventListener('DOMContentLoaded', () => {
            const confirmPasswordInput = document.getElementById('confirm-password');
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') resetPassword();
                });
            }
        });
    </script>
</body>
</html>